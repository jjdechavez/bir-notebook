name: Release Version
on:
  push:
    tags:
      - 'v*' # Triggers on v1.0, v2.1.3, etc.

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        # This turns 'refs/tags/v1.0.0' into 'v1.0.0'
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build & Push Web (Notice the build-args)
      - name: Build Web
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/web/Dockerfile
          push: true
          build-args: |
            PORT=3333
            APP_KEY=dummy-key-for-build
            HOST=0.0.0.0
            LOG_LEVEL=info
            DB_HOST=localhost
            DB_PORT=5432
            DB_USER=user
            DB_PASSWORD=password
            DB_DATABASE=db
            FE_URL=http://localhost:80
          tags: |
            ghcr.io/${{ github.repository }}-web:latest
            ghcr.io/${{ github.repository }}-web:${{ steps.get_version.outputs.VERSION }}

      # Build & Push Server
      - name: Build Server
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/server/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}-server:latest
            ghcr.io/${{ github.repository }}-server:${{ steps.get_version.outputs.VERSION }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Add Host to known_hosts
        run: ssh-keyscan -H ${{ secrets.DO_HOST }} >> ~/.ssh/known_hosts

      - name: Copy Docker Compose file
        run: scp ${{ github.workspace }}/docker-compose.prod.yml root@${{ secrets.DO_HOST }}:/opt/bir-notebook/docker-compose.prod.yml

      - name: Run Database Migrations
        run: |
          ssh root@${{ secrets.DO_HOST }} << EOF
            cd /opt/bir-notebook
            docker compose -f docker-compose.prod.yml run --rm server node ace migration:run --force
          EOF

      - name: Deploy to Digital Ocean
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          ssh root@${{ secrets.DO_HOST }} << EOF
            cd /opt/bir-notebook
            
            echo "APP_VERSION=$VERSION" > .env
            echo "NODE_ENV=production" >> .env
            
            # Update Server Secrets in .env
            echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
            echo "DB_USER=${{ secrets.DB_USER }}" >> .env
            echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
            echo "FE_URL=${{ secrets.FE_URL }}" >> .env
            
            docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            docker system prune -f
          EOF
